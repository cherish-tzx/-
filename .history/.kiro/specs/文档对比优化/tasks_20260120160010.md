# 实施计划: 文档对比优化

## 概述

通过引入文本规范化、优化差异检测算法、重构相似度计算，解决文档对比的准确性问题。实施分为四个主要阶段：创建规范化器、优化差异引擎、重构相似度计算、增强文件解析。

## 任务

- [ ] 1. 创建 TextNormalizer 组件
  - [ ] 1.1 实现 TextNormalizer 类
    - 创建 `src/services/textNormalizer.ts`
    - 实现 `normalizeLine()` 方法：移除行尾空白、压缩连续空白
    - 实现 `normalizeText()` 方法：规范化整个文本
    - 实现 `normalizeToLines()` 方法：规范化并分割为行数组
    - _需求: 1.1, 1.2, 1.3, 1.4_

  - [ ] 1.2 为 TextNormalizer 编写属性测试
    - **属性 1: 规范化保持幂等性**
    - **验证需求: 1.5**

  - [ ] 1.3 为 TextNormalizer 编写属性测试
    - **属性 2: 规范化移除格式保留内容**
    - **验证需求: 1.2, 1.3, 1.4**

  - [ ] 1.4 为 TextNormalizer 编写单元测试
    - 测试边界情况：空字符串、纯空白、null/undefined
    - 测试特殊字符处理
    - _需求: 1.1_

- [ ] 2. 优化 DiffEngine
  - [ ] 2.1 集成 TextNormalizer 到 DiffEngine
    - 修改 `computeDiff()` 方法，在对比前规范化文本
    - 更新 `lineDiff()` 使用规范化后的行
    - 调整相似度阈值从 0.3 到 0.5
    - _需求: 1.1, 2.5_

  - [ ] 2.2 为差异检测编写属性测试
    - **属性 3: 相同内容标记为未变化**
    - **验证需求: 2.1**

  - [ ] 2.3 为差异检测编写属性测试
    - **属性 4: 删除内容正确标记**
    - **验证需求: 2.2**

  - [ ] 2.4 为差异检测编写属性测试
    - **属性 5: 新增内容正确标记**
    - **验证需求: 2.3**

  - [ ] 2.5 为差异检测编写属性测试
    - **属性 6: 修改内容正确标记并计算行内差异**
    - **验证需求: 2.4**

  - [ ] 2.6 为行内差异编写属性测试
    - **属性 15: 行内差异完整性**
    - **验证需求: 4.5**

  - [ ] 2.7 为 DiffEngine 编写单元测试
    - 测试复杂差异场景
    - 测试边界情况：空文档、单行文档
    - _需求: 2.1, 2.2, 2.3, 2.4_

- [ ] 3. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 4. 重构 SimilarityCalculator
  - [ ] 4.1 实现 LCS 算法
    - 在 `SimilarityCalculator` 中添加 `longestCommonSubsequence()` 私有方法
    - 实现动态规划 LCS 算法
    - 更新 `calculate()` 方法使用 LCS 计算相似度
    - 更新 `calculateFromContent()` 方法使用规范化文本和 LCS
    - _需求: 3.4_

  - [ ] 4.2 为相似度计算编写属性测试
    - **属性 7: 相似度基于规范化文本**
    - **验证需求: 3.1**

  - [ ] 4.3 为相似度计算编写属性测试
    - **属性 8: 完全相同文档相似度为 100%**
    - **验证需求: 3.2**

  - [ ] 4.4 为相似度计算编写属性测试
    - **属性 9: 完全不同文档相似度接近 0%**
    - **验证需求: 3.3**

  - [ ] 4.5 为相似度计算编写属性测试
    - **属性 10: LCS 相似度对称性**
    - **验证需求: 3.4**

  - [ ] 4.6 为 SimilarityCalculator 编写单元测试
    - 测试 LCS 边界情况
    - 测试空文档处理
    - 测试除零保护
    - _需求: 3.5_

- [ ] 5. 增强 FileParser
  - [ ] 5.1 优化 Excel 解析
    - 修改 `parseExcel()` 方法
    - 对每个单元格调用 `trim()` 移除前后空白
    - 过滤空单元格和纯空白单元格
    - 移除行尾空单元格
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [ ] 5.2 为 Excel 解析编写属性测试
    - **属性 11: Excel 单元格清理**
    - **验证需求: 5.1, 5.2**

  - [ ] 5.3 为 Excel 解析编写属性测试
    - **属性 12: Excel 行格式一致性**
    - **验证需求: 5.3, 5.4**

  - [ ] 5.4 优化 Word 解析
    - 修改 `parseWord()` 方法
    - 确保提取纯文本（已实现）
    - 在返回前对文本调用 TextNormalizer
    - _需求: 6.1, 6.2, 6.3_

  - [ ] 5.5 为 Word 解析编写属性测试
    - **属性 13: Word 格式忽略**
    - **验证需求: 6.1, 6.3**

  - [ ] 5.6 为 Word 解析编写属性测试
    - **属性 14: Word 段落结构保留**
    - **验证需求: 6.2, 6.4**

  - [ ] 5.7 为 FileParser 编写单元测试
    - 测试文件格式错误处理
    - 测试边界情况
    - _需求: 5.1, 5.2, 6.1, 6.2_

- [ ] 6. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 7. 集成和验证
  - [ ] 7.1 更新现有测试
    - 更新 `fileParser.test.ts` 以适应新的规范化行为
    - 更新 `fileParser.property.test.ts` 以适应新的规范化行为
    - 确保所有现有测试通过
    - _需求: 所有_

  - [ ] 7.2 端到端集成测试
    - 测试完整的文件上传 → 解析 → 对比 → 相似度计算流程
    - 验证颜色标记逻辑正确（通过 DiffLine.type）
    - _需求: 所有_

- [ ] 8. 最终检查点
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 每个任务引用具体需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
