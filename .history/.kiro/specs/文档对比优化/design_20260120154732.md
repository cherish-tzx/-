# 设计文档

## 概述

本设计优化文档对比系统的核心算法，解决相似度计算不准确、差异识别错误、颜色标记混乱等问题。通过引入文本规范化、改进差异检测算法、使用 LCS 相似度计算，确保对比结果准确可靠。

## 架构

系统采用三层处理架构：

1. **规范化层** - TextNormalizer 负责文本预处理
2. **差异检测层** - DiffEngine 负责计算文本差异
3. **相似度计算层** - SimilarityCalculator 负责计算相似度

```
文件输入 → 解析器 → 规范化器 → 差异引擎 → 相似度计算 → 结果输出
```

## 组件和接口

### TextNormalizer (新增)

文本规范化器，负责统一文本格式。

```typescript
class TextNormalizer {
  // 规范化单行文本
  normalizeLine(line: string): string
  
  // 规范化多行文本
  normalizeText(text: string): string
  
  // 规范化文本为行数组
  normalizeToLines(text: string): string[]
}
```

**规范化规则：**

- 移除行尾空白字符
- 将连续空白字符（空格/制表符）压缩为单个空格
- 移除空行
- 保留文本语义内容

### DiffEngine (优化)

差异检测引擎，计算文本差异。

```typescript
class DiffEngine {
  // 计算差异（使用规范化文本）
  computeDiff(content1: string, content2: string): DiffResult
  
  // 行级差异检测
  private lineDiff(lines1: string[], lines2: string[]): {
    leftLines: DiffLine[]
    rightLines: DiffLine[]
  }
  
  // 检测修改的行（提高阈值到 0.5）
  private detectModifiedLines(leftLines: DiffLine[], rightLines: DiffLine[]): void
  
  // 计算行相似度
  private calculateLineSimilarity(line1: string, line2: string): number
  
  // 行内字符差异
  private inlineDiff(line1: string, line2: string): InlineChange[]
}
```

**关键改进：**

- 在对比前规范化文本
- 修改判定阈值从 0.3 提高到 0.5
- 使用规范化后的文本计算相似度

### SimilarityCalculator (重构)

相似度计算器，使用 LCS 算法。

```typescript
class SimilarityCalculator {
  // 基于 LCS 计算相似度
  calculate(diffResult: DiffResult): number
  
  // 直接从内容计算相似度（使用 LCS）
  calculateFromContent(content1: string, content2: string): number
  
  // LCS 算法实现
  private longestCommonSubsequence(lines1: string[], lines2: string[]): number
}
```

**LCS 相似度公式：**

```
similarity = (2 * LCS_length) / (lines1.length + lines2.length) * 100
```

### FileParser (优化)

文件解析器，增强 Excel 和 Word 处理。

```typescript
class FileParser {
  // Excel 解析（优化单元格处理）
  async parseExcel(file: File): Promise<ParsedContent>
  
  // Word 解析（优化段落处理）
  async parseWord(file: File): Promise<ParsedContent>
  
  // 统一解析接口
  async parse(file: File): Promise<ParsedContent>
}
```

**Excel 优化：**

- 移除单元格前后空白
- 过滤空单元格
- 忽略尾部空单元格

**Word 优化：**

- 提取纯文本
- 规范化段落间空白

## 数据模型

无需修改现有数据模型，继续使用：

```typescript
interface DiffResult {
  leftLines: DiffLine[]
  rightLines: DiffLine[]
  similarity: number
  totalLines: number
  changedLines: number
}

interface DiffLine {
  lineNumber: number
  content: string
  type: 'added' | 'removed' | 'modified' | 'unchanged'
  changes?: InlineChange[]
}

interface InlineChange {
  value: string
  type: 'added' | 'removed' | 'unchanged'
}
```

## 正确性属性

*属性是关于系统应该满足的特征或行为的形式化陈述，适用于所有有效执行。属性是人类可读规范和机器可验证正确性保证之间的桥梁。*
